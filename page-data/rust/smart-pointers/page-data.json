{
    "componentChunkName": "component---src-templates-blog-post-js",
    "path": "/rust/smart-pointers/",
    "result": {"data":{"site":{"siteMetadata":{"title":"Tech Notes"}},"markdownRemark":{"id":"c751c5f1-01aa-5148-a02b-b6ee6906e5c5","excerpt":"are data structures that not only act like a pointer but also have additional\nmetadata and capabilities. e.g.  and  are smart pointers. They own some memory and…","html":"<p><code class=\"language-text\">Smart pointers</code> are data structures that not only act like a pointer but also have additional\nmetadata and capabilities.</p>\n<p>e.g. <code class=\"language-text\">String</code> and <code class=\"language-text\">Vec&lt;T></code> are smart pointers. They own some memory and allow to manipulate it.\nThey also have metadata (such as their capacity) and extra capabilities or guarantees (such as\nwith <code class=\"language-text\">String</code> ensuring its data will always be valid <code class=\"language-text\">UTF-8</code>).</p>\n<p>Smart pointers are usually implemented using structs. The characteristic that distinguishes a\nsmart pointer from an ordinary struct is that smart pointers implement the <code class=\"language-text\">Deref</code> and <code class=\"language-text\">Drop</code> traits.\nThe <code class=\"language-text\">Deref</code> trait allows an instance of the smart pointer struct to behave like a reference so\nyou can write code that works with either references or smart pointers. The <code class=\"language-text\">Drop</code> trait allows\nyou to customize the code that is run when an instance of the smart pointer goes out of scope.</p>\n<p>Examples from standard library:</p>\n<ul>\n<li><code class=\"language-text\">Box&lt;T></code> for allocating values on the heap</li>\n<li><code class=\"language-text\">Rc&lt;T></code>, a reference counting type that enables multiple ownership</li>\n<li><code class=\"language-text\">Ref&lt;T></code> and <code class=\"language-text\">RefMut&lt;T></code>, accessed through <code class=\"language-text\">RefCell&lt;T></code>, a type that enforces the borrowing\nrules at runtime instead of compile time</li>\n</ul>\n<h2>Box<T></h2>\n<p>Boxes allow you to store data on the heap rather than the stack. What remains on the stack is the\npointer to the heap data.</p>\n<p>They are used mostly for:</p>\n<ul>\n<li>When you have a type whose size can’t be known at compile time and you want to use a value of\nthat type in a context that requires an exact size</li>\n<li>When you have a large amount of data and you want to transfer ownership but ensure the data\nwon’t be copied when you do so</li>\n<li>When you want to own a value and you care only that it’s a type that implements a particular\ntrait rather than being of a specific type</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> b <span class=\"token operator\">=</span> <span class=\"token class-name\">Box</span><span class=\"token punctuation\">::</span><span class=\"token function\">new</span><span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"b = {}\"</span><span class=\"token punctuation\">,</span> b<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>At compile time, Rust needs to know how much space a type takes up. One type whose size can’t be\nknown at compile time is a recursive type, where a value can have as part of itself another value\nof the same type. Because this nesting of values could theoretically continue infinitely, Rust\ndoesn’t know how much space a value of a recursive type needs. However, boxes have a known size,\nso by inserting a box in a recursive type definition, you can have recursive types.</p>\n<h2>Linked List</h2>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">enum</span> <span class=\"token type-definition class-name\">List</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">Cons</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">i32</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Box</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">List</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token class-name\">Nil</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">use</span> <span class=\"token keyword\">crate</span><span class=\"token punctuation\">::</span><span class=\"token class-name\">List</span><span class=\"token punctuation\">::</span><span class=\"token punctuation\">{</span><span class=\"token class-name\">Cons</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Nil</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> list <span class=\"token operator\">=</span> <span class=\"token class-name\">Cons</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Box</span><span class=\"token punctuation\">::</span><span class=\"token function\">new</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Cons</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Box</span><span class=\"token punctuation\">::</span><span class=\"token function\">new</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Cons</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Box</span><span class=\"token punctuation\">::</span><span class=\"token function\">new</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Nil</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>Deref Trait</h2>\n<p>Implementing the <code class=\"language-text\">Deref</code> trait allows to customize the behavior of the dereference operator <code class=\"language-text\">*</code>.</p>\n<p>A regular reference is a type of pointer, and one way to think of a pointer is as an arrow to a\nvalue stored somewhere else.</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> x <span class=\"token operator\">=</span> <span class=\"token number\">5</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> y <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span>x<span class=\"token punctuation\">;</span>\n\n    <span class=\"token macro property\">assert_eq!</span><span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token macro property\">assert_eq!</span><span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>y<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>The variable <code class=\"language-text\">x</code> holds an <code class=\"language-text\">i32</code> value, <code class=\"language-text\">5</code>. We set <code class=\"language-text\">y</code> equal to a reference to <code class=\"language-text\">x</code>. We can assert\nthat <code class=\"language-text\">x</code> is equal to <code class=\"language-text\">5</code>. However, if we want to make an assertion about the value in <code class=\"language-text\">y</code>, we have\nto use <code class=\"language-text\">*y</code> to follow the reference to the value it’s pointing to (hence dereference). Once we\ndereference <code class=\"language-text\">y</code>, we have access to the integer value <code class=\"language-text\">y</code> is pointing to that we can compare with <code class=\"language-text\">5</code>.</p>\n<p>Comparing a number and a reference to a number isn’t allowed because they’re different types. We must use the dereference operator to follow the reference to the value it’s pointing to.</p>\n<p>It is possible to rewrite this code with <code class=\"language-text\">Box&lt;T></code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> x <span class=\"token operator\">=</span> <span class=\"token number\">5</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> y <span class=\"token operator\">=</span> <span class=\"token class-name\">Box</span><span class=\"token punctuation\">::</span><span class=\"token function\">new</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token macro property\">assert_eq!</span><span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token macro property\">assert_eq!</span><span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>y<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>Custom Smart Pointers</h2>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">use</span> <span class=\"token namespace\">std<span class=\"token punctuation\">::</span>ops<span class=\"token punctuation\">::</span></span><span class=\"token class-name\">Deref</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">struct</span> <span class=\"token type-definition class-name\">MyBox</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">impl</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token operator\">></span> <span class=\"token class-name\">MyBox</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">new</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">:</span> <span class=\"token class-name\">T</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-></span> <span class=\"token class-name\">MyBox</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">MyBox</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">impl</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token operator\">></span> <span class=\"token class-name\">Deref</span> <span class=\"token keyword\">for</span> <span class=\"token class-name\">MyBox</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">type</span> <span class=\"token class-name\">Target</span> <span class=\"token operator\">=</span> <span class=\"token class-name\">T</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">deref</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-></span> <span class=\"token operator\">&amp;</span><span class=\"token keyword\">Self</span><span class=\"token punctuation\">::</span><span class=\"token class-name\">Target</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token operator\">&amp;</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span><span class=\"token number\">0</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Rust substitutes the <code class=\"language-text\">*</code> operator with a call to the <code class=\"language-text\">deref</code> method and then a plain dereference\nso we don’t have to think about whether or not we need to call the deref method.</p>\n<p>Deref coercion is a convenience that Rust performs on arguments to functions and methods.\nDeref coercion works only on types that implement the Deref trait. Deref coercion converts such\na type into a reference to another type. For example, deref coercion can convert <code class=\"language-text\">&amp;String</code> to <code class=\"language-text\">&amp;str</code>\nbecause <code class=\"language-text\">String</code> implements the <code class=\"language-text\">Deref</code> trait such that it returns <code class=\"language-text\">&amp;str</code>. Deref coercion happens\nautomatically when we pass a reference to a particular type’s value as an argument to a function\nor method that doesn’t match the parameter type in the function or method definition. A sequence\nof calls to the deref method converts the type we provided into the type the parameter needs.</p>\n<p>Example of deref coercion:</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">hello</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">:</span> <span class=\"token operator\">&amp;</span><span class=\"token keyword\">str</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Hello, {}!\"</span><span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> m <span class=\"token operator\">=</span> <span class=\"token class-name\">MyBox</span><span class=\"token punctuation\">::</span><span class=\"token function\">new</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">::</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Rust\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">hello</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>m<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Similar to immutable references, you can use the <code class=\"language-text\">DerefMut</code> trait to override the <code class=\"language-text\">*</code> operator\non mutable references.</p>\n<p>Rust does deref coercion when it finds types and trait implementations in three cases:</p>\n<ul>\n<li>From <code class=\"language-text\">&amp;T</code> to <code class=\"language-text\">&amp;U</code> when <code class=\"language-text\">T: Deref&lt;Target=U></code></li>\n<li>From <code class=\"language-text\">&amp;mut T</code> to <code class=\"language-text\">&amp;mut U</code> when <code class=\"language-text\">T: DerefMut&lt;Target=U></code></li>\n<li>From <code class=\"language-text\">&amp;mut T</code> to <code class=\"language-text\">&amp;U</code> when <code class=\"language-text\">T: Deref&lt;Target=U></code></li>\n</ul>\n<p>The first two cases are the same except for mutability. The first case states that if you have a\n<code class=\"language-text\">&amp;T</code>, and <code class=\"language-text\">T</code> implements <code class=\"language-text\">Deref</code> to some type <code class=\"language-text\">U</code>, you can get a <code class=\"language-text\">&amp;U</code> transparently. The second\ncase states that the same deref coercion happens for mutable references.</p>\n<h2>Drop</h2>\n<p><code class=\"language-text\">Drop</code>, which lets you customize what happens when a value is about to go out of scope. You can\nprovide an implementation for the Drop trait on any type, and the code you specify can be used to\nrelease resources like files or network connections. For example, when a <code class=\"language-text\">Box&lt;T></code> is dropped it\nwill deallocate the space on the heap that the box points to.</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">struct</span> <span class=\"token type-definition class-name\">CustomSmartPointer</span> <span class=\"token punctuation\">{</span>\n    data<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">impl</span> <span class=\"token class-name\">Drop</span> <span class=\"token keyword\">for</span> <span class=\"token class-name\">CustomSmartPointer</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">drop</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span><span class=\"token keyword\">mut</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Dropping CustomSmartPointer with data `{}`!\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> c <span class=\"token operator\">=</span> <span class=\"token class-name\">CustomSmartPointer</span> <span class=\"token punctuation\">{</span>\n        data<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">::</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"my stuff\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> d <span class=\"token operator\">=</span> <span class=\"token class-name\">CustomSmartPointer</span> <span class=\"token punctuation\">{</span>\n        data<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">::</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"other stuff\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"CustomSmartPointers created.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>this will print:</p>\n<div class=\"gatsby-highlight\" data-language=\"log\"><pre class=\"language-log\"><code class=\"language-log\">CustomSmartPointers created<span class=\"token punctuation\">.</span>\nDropping CustomSmartPointer with data `other stuff`<span class=\"token operator\">!</span>\nDropping CustomSmartPointer with data `my stuff`<span class=\"token operator\">!</span></code></pre></div>\n<p>Variables are dropped in the reverse order of their creation, so <code class=\"language-text\">d</code> was dropped before <code class=\"language-text\">c</code>.</p>\n<h2>Reference Counted Smart Pointers</h2>\n<p><code class=\"language-text\">Rc&lt;T></code> - reference counted smart pointer allows to have multiple ownership on same entity.\nThe <code class=\"language-text\">Rc&lt;T></code> type keeps track of the number of references to a value to determine whether or not\nthe value is still in use. If there are zero references to a value, the value can be cleaned up\nwithout any references becoming invalid.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/8e16e6f61533eaf71cf35eb677d52097/776d3/smart_pointers_1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 46.202531645569614%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABJElEQVQoz41STYuCUBT11/sj/AfhroVLP8gWYSktQhNSS0WzhJBcCOoZ7o0Hj5lppgOHh/e9e+7HUdlut7jdbjgejyiKAqvVCpZl4X6/gzCOIwTmeWb+BcV1XaRpisPhwKKO42C5XMK2bXRdx4+maWLKooIUFydREV1QUO6m73tsNhsuIiCLvu1QXMqnSCRQ94vFAqZp4nQ6cYHL5QLP87Db7RDHMa8nyzIkSfIS/I1yt6qqQtM0tG2LKIpYgFZDokEQ4Hq98rdhGK+R3+H5fGK/36MsSzweD+R5jqqqWIBidV3/HJmS6BFd0iOqTvsjx33fZ9H/IAxhU8jl8/mMMAx5H7QrXddZTE6QHZVd/e6BQk42TcMdEdfrNf8ywzB87Kw88hdlwaowWKWOkQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"shared ownership\"\n        title=\"shared ownership\"\n        src=\"/static/8e16e6f61533eaf71cf35eb677d52097/f058b/smart_pointers_1.png\"\n        srcset=\"/static/8e16e6f61533eaf71cf35eb677d52097/c26ae/smart_pointers_1.png 158w,\n/static/8e16e6f61533eaf71cf35eb677d52097/6bdcf/smart_pointers_1.png 315w,\n/static/8e16e6f61533eaf71cf35eb677d52097/f058b/smart_pointers_1.png 630w,\n/static/8e16e6f61533eaf71cf35eb677d52097/40601/smart_pointers_1.png 945w,\n/static/8e16e6f61533eaf71cf35eb677d52097/78612/smart_pointers_1.png 1260w,\n/static/8e16e6f61533eaf71cf35eb677d52097/776d3/smart_pointers_1.png 1814w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Here <code class=\"language-text\">b</code> and <code class=\"language-text\">c</code> have references to <code class=\"language-text\">a</code>.</p>\n<p>This is highly useful in many use cases, for example in graphs and it’s derivatives - trees, linked lists e.t.c.</p>\n<p><em><code class=\"language-text\">Rc&lt;T></code> is only for single threaded usecase</em></p>\n<p>Example of the problem:</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">enum</span> <span class=\"token type-definition class-name\">List</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">Cons</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">i32</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Box</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">List</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token class-name\">Nil</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">use</span> <span class=\"token keyword\">crate</span><span class=\"token punctuation\">::</span><span class=\"token class-name\">List</span><span class=\"token punctuation\">::</span><span class=\"token punctuation\">{</span><span class=\"token class-name\">Cons</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Nil</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> a <span class=\"token operator\">=</span> <span class=\"token class-name\">Cons</span><span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Box</span><span class=\"token punctuation\">::</span><span class=\"token function\">new</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Cons</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Box</span><span class=\"token punctuation\">::</span><span class=\"token function\">new</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Nil</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> b <span class=\"token operator\">=</span> <span class=\"token class-name\">Cons</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Box</span><span class=\"token punctuation\">::</span><span class=\"token function\">new</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> c <span class=\"token operator\">=</span> <span class=\"token class-name\">Cons</span><span class=\"token punctuation\">(</span><span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Box</span><span class=\"token punctuation\">::</span><span class=\"token function\">new</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>This code will not compile, because here multiple ownership of <code class=\"language-text\">a</code> occures, which is not allowed.</p>\n<p>Fix it with <code class=\"language-text\">Rc&lt;T></code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">enum</span> <span class=\"token type-definition class-name\">List</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">Cons</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">i32</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Rc</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">List</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token class-name\">Nil</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">use</span> <span class=\"token keyword\">crate</span><span class=\"token punctuation\">::</span><span class=\"token class-name\">List</span><span class=\"token punctuation\">::</span><span class=\"token punctuation\">{</span><span class=\"token class-name\">Cons</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Nil</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> <span class=\"token namespace\">std<span class=\"token punctuation\">::</span>rc<span class=\"token punctuation\">::</span></span><span class=\"token class-name\">Rc</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> a <span class=\"token operator\">=</span> <span class=\"token class-name\">Rc</span><span class=\"token punctuation\">::</span><span class=\"token function\">new</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Cons</span><span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Rc</span><span class=\"token punctuation\">::</span><span class=\"token function\">new</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Cons</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Rc</span><span class=\"token punctuation\">::</span><span class=\"token function\">new</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Nil</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> b <span class=\"token operator\">=</span> <span class=\"token class-name\">Cons</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Rc</span><span class=\"token punctuation\">::</span><span class=\"token function\">clone</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>a<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> c <span class=\"token operator\">=</span> <span class=\"token class-name\">Cons</span><span class=\"token punctuation\">(</span><span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Rc</span><span class=\"token punctuation\">::</span><span class=\"token function\">clone</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>a<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Every time we call <code class=\"language-text\">Rc::clone</code>, the reference count to the data within the <code class=\"language-text\">Rc&lt;List></code> will\nincrease, and the data won’t be cleaned up unless there are zero references to it.</p>\n<p>The call to <code class=\"language-text\">Rc::clone</code> only increments the reference count, which doesn’t take much time. Deep\ncopies of data can take a lot of time. By using <code class=\"language-text\">Rc::clone</code> for reference counting, we can visually\ndistinguish between the deep-copy kinds of clones and the kinds of clones that increase the\nreference count.</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> a <span class=\"token operator\">=</span> <span class=\"token class-name\">Rc</span><span class=\"token punctuation\">::</span><span class=\"token function\">new</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Cons</span><span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Rc</span><span class=\"token punctuation\">::</span><span class=\"token function\">new</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Cons</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Rc</span><span class=\"token punctuation\">::</span><span class=\"token function\">new</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Nil</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"count after creating a = {}\"</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Rc</span><span class=\"token punctuation\">::</span><span class=\"token function\">strong_count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>a<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> b <span class=\"token operator\">=</span> <span class=\"token class-name\">Cons</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Rc</span><span class=\"token punctuation\">::</span><span class=\"token function\">clone</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>a<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"count after creating b = {}\"</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Rc</span><span class=\"token punctuation\">::</span><span class=\"token function\">strong_count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>a<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">let</span> c <span class=\"token operator\">=</span> <span class=\"token class-name\">Cons</span><span class=\"token punctuation\">(</span><span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Rc</span><span class=\"token punctuation\">::</span><span class=\"token function\">clone</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>a<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"count after creating c = {}\"</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Rc</span><span class=\"token punctuation\">::</span><span class=\"token function\">strong_count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>a<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"count after c goes out of scope = {}\"</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Rc</span><span class=\"token punctuation\">::</span><span class=\"token function\">strong_count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>a<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>This will result in:</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\">count after creating a <span class=\"token operator\">=</span> <span class=\"token number\">1</span>\ncount after creating b <span class=\"token operator\">=</span> <span class=\"token number\">2</span>\ncount after creating c <span class=\"token operator\">=</span> <span class=\"token number\">3</span>\ncount after c goes out of scope <span class=\"token operator\">=</span> <span class=\"token number\">2</span></code></pre></div>\n<p><strong>Dereferencing <code class=\"language-text\">Rc&lt;T></code>:</strong></p>\n<p>To dereference <code class=\"language-text\">Rc&lt;T></code> used operator <code class=\"language-text\">*</code>, but it is also can be done implicitly. So it\nis possible to do:</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">let</span> x <span class=\"token operator\">=</span> <span class=\"token class-name\">Rc</span><span class=\"token punctuation\">::</span><span class=\"token function\">new</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"value\"</span><span class=\"token punctuation\">.</span><span class=\"token function\">to_string</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token macro property\">print!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"let: {}\"</span><span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">.</span><span class=\"token function\">len</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><strong>Moving value from <code class=\"language-text\">Rc&lt;T></code>:</strong></p>\n<p>Sometimes it is useful to move ownership on the underlying value from <code class=\"language-text\">Rc</code> to somewhere else.\nIt may be done with <code class=\"language-text\">Rc::try_unwrap(rc_pointer)</code>. But there is a complexity - such move may\nbe done only in case, when there is only one strong reference exists in this <code class=\"language-text\">Rc</code>. In other\ncase <code class=\"language-text\">try_unwrap</code> will return an error.</p>\n<h2>Interior Mutability And <code class=\"language-text\">RefCell</code></h2>\n<h2>Memory Leaks</h2>\n<p>It is possible to create memory leak in <code class=\"language-text\">Rust</code> with <code class=\"language-text\">Rc&lt;T></code> or <code class=\"language-text\">RefCell&lt;T></code> by creating cycle\nreferences. Such a way that one object may reference itself and always having active references\nit will not be cleaned.</p>\n<p>For example:</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">use</span> <span class=\"token keyword\">crate</span><span class=\"token punctuation\">::</span><span class=\"token class-name\">List</span><span class=\"token punctuation\">::</span><span class=\"token punctuation\">{</span><span class=\"token class-name\">Cons</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Nil</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> <span class=\"token namespace\">std<span class=\"token punctuation\">::</span>cell<span class=\"token punctuation\">::</span></span><span class=\"token class-name\">RefCell</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> <span class=\"token namespace\">std<span class=\"token punctuation\">::</span>rc<span class=\"token punctuation\">::</span></span><span class=\"token class-name\">Rc</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token attribute attr-name\">#[derive(Debug)]</span>\n<span class=\"token keyword\">enum</span> <span class=\"token type-definition class-name\">List</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">Cons</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">i32</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">RefCell</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">Rc</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">List</span><span class=\"token operator\">>></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token class-name\">Nil</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">impl</span> <span class=\"token class-name\">List</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">tail</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-></span> <span class=\"token class-name\">Option</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">&amp;</span><span class=\"token class-name\">RefCell</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">Rc</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">List</span><span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">match</span> <span class=\"token keyword\">self</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token class-name\">Cons</span><span class=\"token punctuation\">(</span>_<span class=\"token punctuation\">,</span> item<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token class-name\">Some</span><span class=\"token punctuation\">(</span>item<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token class-name\">Nil</span> <span class=\"token operator\">=></span> <span class=\"token class-name\">None</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> a <span class=\"token operator\">=</span> <span class=\"token class-name\">Rc</span><span class=\"token punctuation\">::</span><span class=\"token function\">new</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Cons</span><span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">RefCell</span><span class=\"token punctuation\">::</span><span class=\"token function\">new</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Rc</span><span class=\"token punctuation\">::</span><span class=\"token function\">new</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Nil</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"a initial rc count = {}\"</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Rc</span><span class=\"token punctuation\">::</span><span class=\"token function\">strong_count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>a<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"a next item = {:?}\"</span><span class=\"token punctuation\">,</span> a<span class=\"token punctuation\">.</span><span class=\"token function\">tail</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">let</span> b <span class=\"token operator\">=</span> <span class=\"token class-name\">Rc</span><span class=\"token punctuation\">::</span><span class=\"token function\">new</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Cons</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">RefCell</span><span class=\"token punctuation\">::</span><span class=\"token function\">new</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Rc</span><span class=\"token punctuation\">::</span><span class=\"token function\">clone</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>a<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"a rc count after b creation = {}\"</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Rc</span><span class=\"token punctuation\">::</span><span class=\"token function\">strong_count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>a<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"b initial rc count = {}\"</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Rc</span><span class=\"token punctuation\">::</span><span class=\"token function\">strong_count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>b<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"b next item = {:?}\"</span><span class=\"token punctuation\">,</span> b<span class=\"token punctuation\">.</span><span class=\"token function\">tail</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token keyword\">let</span> <span class=\"token class-name\">Some</span><span class=\"token punctuation\">(</span>link<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> a<span class=\"token punctuation\">.</span><span class=\"token function\">tail</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token operator\">*</span>link<span class=\"token punctuation\">.</span><span class=\"token function\">borrow_mut</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token class-name\">Rc</span><span class=\"token punctuation\">::</span><span class=\"token function\">clone</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>b<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"b rc count after changing a = {}\"</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Rc</span><span class=\"token punctuation\">::</span><span class=\"token function\">strong_count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>b<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"a rc count after changing a = {}\"</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Rc</span><span class=\"token punctuation\">::</span><span class=\"token function\">strong_count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>a<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// Uncomment the next line to see that we have a cycle;</span>\n  <span class=\"token comment\">// it will overflow the stack</span>\n  <span class=\"token comment\">// println!(\"a next item = {:?}\", a.tail());</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>Preventing Reference Cycles</h2>\n<p>So far, we’ve demonstrated that calling Rc::clone increases the strong_count of an Rc<T> instance, and an Rc<T> instance is only cleaned up if its strong_count is 0. You can also create a weak reference to the value within an Rc<T> instance by calling Rc::downgrade and passing a reference to the Rc<T>. When you call Rc::downgrade, you get a smart pointer of type Weak<T>. Instead of increasing the strong_count in the Rc<T> instance by 1, calling Rc::downgrade increases the weak_count by 1. The Rc<T> type uses weak_count to keep track of how many Weak<T> references exist, similar to strong_count. The difference is the weak_count doesn’t need to be 0 for the Rc<T> instance to be cleaned up.</p>\n<p>Strong references are how you can share ownership of an Rc<T> istance. Weak references don’t express an ownership relationship. They won’t cause a reference cycle because any cycle involving some weak references will be broken once the strong reference count of values involved is 0.</p>\n<p>Because the value that Weak<T> references might have been dropped, to do anything with the value that a Weak<T> is pointing to, you must make sure the value still exists. Do this by calling the upgrade method on a Weak<T> instance, which will return an Option&#x3C;Rc<T>>. You’ll get a result of Some if the Rc<T> value has not been dropped yet and a result of None if the Rc<T> value has been dropped. Because upgrade returns an Option&#x3C;Rc<T>>, Rust will ensure that the Some case and the None case are handled, and there won’t be an invalid pointer.</p>\n<p>As an example, rather than using a list whose items know only about the next item, we’ll create a tree whose items know about their children items and their parent items.</p>\n<h2>Tree</h2>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">use</span> <span class=\"token namespace\">std<span class=\"token punctuation\">::</span>cell<span class=\"token punctuation\">::</span></span><span class=\"token class-name\">RefCell</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> <span class=\"token namespace\">std<span class=\"token punctuation\">::</span>rc<span class=\"token punctuation\">::</span></span><span class=\"token punctuation\">{</span><span class=\"token class-name\">Rc</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Weak</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token attribute attr-name\">#[derive(Debug)]</span>\n<span class=\"token keyword\">struct</span> <span class=\"token type-definition class-name\">Node</span> <span class=\"token punctuation\">{</span>\n    value<span class=\"token punctuation\">:</span> <span class=\"token keyword\">i32</span><span class=\"token punctuation\">,</span>\n    parent<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RefCell</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">Weak</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">Node</span><span class=\"token operator\">>></span><span class=\"token punctuation\">,</span>\n    children<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RefCell</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">Vec</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">Rc</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">Node</span><span class=\"token operator\">>></span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> leaf <span class=\"token operator\">=</span> <span class=\"token class-name\">Rc</span><span class=\"token punctuation\">::</span><span class=\"token function\">new</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Node</span> <span class=\"token punctuation\">{</span>\n        value<span class=\"token punctuation\">:</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span>\n        parent<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RefCell</span><span class=\"token punctuation\">::</span><span class=\"token function\">new</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Weak</span><span class=\"token punctuation\">::</span><span class=\"token function\">new</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        children<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RefCell</span><span class=\"token punctuation\">::</span><span class=\"token function\">new</span><span class=\"token punctuation\">(</span><span class=\"token macro property\">vec!</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span>\n        <span class=\"token string\">\"leaf strong = {}, weak = {}\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token class-name\">Rc</span><span class=\"token punctuation\">::</span><span class=\"token function\">strong_count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>leaf<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token class-name\">Rc</span><span class=\"token punctuation\">::</span><span class=\"token function\">weak_count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>leaf<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">let</span> branch <span class=\"token operator\">=</span> <span class=\"token class-name\">Rc</span><span class=\"token punctuation\">::</span><span class=\"token function\">new</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Node</span> <span class=\"token punctuation\">{</span>\n            value<span class=\"token punctuation\">:</span> <span class=\"token number\">5</span><span class=\"token punctuation\">,</span>\n            parent<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RefCell</span><span class=\"token punctuation\">::</span><span class=\"token function\">new</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Weak</span><span class=\"token punctuation\">::</span><span class=\"token function\">new</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            children<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RefCell</span><span class=\"token punctuation\">::</span><span class=\"token function\">new</span><span class=\"token punctuation\">(</span><span class=\"token macro property\">vec!</span><span class=\"token punctuation\">[</span><span class=\"token class-name\">Rc</span><span class=\"token punctuation\">::</span><span class=\"token function\">clone</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>leaf<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token operator\">*</span>leaf<span class=\"token punctuation\">.</span>parent<span class=\"token punctuation\">.</span><span class=\"token function\">borrow_mut</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token class-name\">Rc</span><span class=\"token punctuation\">::</span><span class=\"token function\">downgrade</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>branch<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span>\n            <span class=\"token string\">\"branch strong = {}, weak = {}\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token class-name\">Rc</span><span class=\"token punctuation\">::</span><span class=\"token function\">strong_count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>branch<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token class-name\">Rc</span><span class=\"token punctuation\">::</span><span class=\"token function\">weak_count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>branch<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span>\n            <span class=\"token string\">\"leaf strong = {}, weak = {}\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token class-name\">Rc</span><span class=\"token punctuation\">::</span><span class=\"token function\">strong_count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>leaf<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token class-name\">Rc</span><span class=\"token punctuation\">::</span><span class=\"token function\">weak_count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>leaf<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"leaf parent = {:?}\"</span><span class=\"token punctuation\">,</span> leaf<span class=\"token punctuation\">.</span>parent<span class=\"token punctuation\">.</span><span class=\"token function\">borrow</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">upgrade</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span>\n        <span class=\"token string\">\"leaf strong = {}, weak = {}\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token class-name\">Rc</span><span class=\"token punctuation\">::</span><span class=\"token function\">strong_count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>leaf<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token class-name\">Rc</span><span class=\"token punctuation\">::</span><span class=\"token function\">weak_count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>leaf<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>References</h2>\n<p><a href=\"https://doc.rust-lang.org/stable/book/ch15-06-reference-cycles.html\">Reference Cycles</a>\n<a href=\"https://doc.rust-lang.org/stable/book/ch15-01-box.html\">Using Box<T> to Point to Data on the Heap</a></p>","frontmatter":{"title":"Rust Smart Pointers","date":"February 26, 2022","description":"Rust smart pointers definition, kinds and usecases."}},"previous":{"fields":{"slug":"/utilites/vim/vim/"},"frontmatter":{"title":"Vim Cheatsheet"}},"next":{"fields":{"slug":"/rust/documenting/"},"frontmatter":{"title":"Rust - Creating Documentation"}}},"pageContext":{"id":"c751c5f1-01aa-5148-a02b-b6ee6906e5c5","previousPostId":"7584746c-c6e8-506d-908b-ef8bc5c0843c","nextPostId":"a03f1a39-1cc3-580e-adea-21aef924b71a"}},
    "staticQueryHashes": ["2063783301","2841359383","3274528899"]}